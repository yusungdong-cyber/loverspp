generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  passwordHash   String          @map("password_hash")
  name           String?
  openaiApiKey   String?         @map("openai_api_key")   // encrypted
  claudeApiKey   String?         @map("claude_api_key")   // encrypted
  aiProvider     String          @default("openai") @map("ai_provider") // "openai" | "claude"
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  wpSites        WpSite[]
  articles       Article[]
  trendSessions  TrendSession[]

  @@map("users")
}

model WpSite {
  id                  String    @id @default(cuid())
  userId              String    @map("user_id")
  siteUrl             String    @map("site_url")
  username            String
  applicationPassword String    @map("application_password") // encrypted
  isConnected         Boolean   @default(false) @map("is_connected")
  lastVerifiedAt      DateTime? @map("last_verified_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  articles Article[]

  @@unique([userId, siteUrl])
  @@map("wp_sites")
}

model TrendSession {
  id        String       @id @default(cuid())
  userId    String       @map("user_id")
  createdAt DateTime     @default(now()) @map("created_at")
  topics    TrendTopic[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("trend_sessions")
}

model TrendTopic {
  id                    String   @id @default(cuid())
  sessionId             String   @map("session_id")
  title                 String
  keyword               String
  searchVolume          Int      @map("search_volume")
  competitionScore      Float    @map("competition_score")   // 0-100
  monetizationScore     Float    @map("monetization_score")  // 0-100
  trendScore            Float    @map("trend_score")         // 0-100 composite
  category              String?
  createdAt             DateTime @default(now()) @map("created_at")

  session  TrendSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  articles Article[]

  @@map("trend_topics")
}

enum ArticleStatus {
  DRAFT
  GENERATING
  READY
  PUBLISHING
  PUBLISHED
  FAILED
}

model Article {
  id                String        @id @default(cuid())
  userId            String        @map("user_id")
  wpSiteId          String?       @map("wp_site_id")
  trendTopicId      String?       @map("trend_topic_id")
  title             String
  slug              String?
  metaDescription   String?       @map("meta_description")
  content           String        @db.Text
  htmlContent       String?       @map("html_content") @db.Text
  featuredImageUrl  String?       @map("featured_image_url")
  featuredImageAlt  String?       @map("featured_image_alt")
  inArticleImages   Json?         @map("in_article_images") // [{url, alt, prompt}]
  schemaMarkup      Json?         @map("schema_markup")     // JSON-LD
  seoScore          Json?         @map("seo_score")         // {keyword, readability, heading, overall}
  primaryKeyword    String?       @map("primary_keyword")
  tags              String[]      @default([])
  categories        String[]      @default([])
  status            ArticleStatus @default(DRAFT)
  wordCount         Int?          @map("word_count")
  wpPostId          Int?          @map("wp_post_id")
  publishedAt       DateTime?     @map("published_at")
  scheduledAt       DateTime?     @map("scheduled_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  wpSite     WpSite?     @relation(fields: [wpSiteId], references: [id], onDelete: SetNull)
  trendTopic TrendTopic? @relation(fields: [trendTopicId], references: [id], onDelete: SetNull)

  @@index([userId, status])
  @@index([userId, createdAt])
  @@map("articles")
}
